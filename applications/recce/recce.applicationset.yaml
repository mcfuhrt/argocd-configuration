apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: recce
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
  - pullRequest:
      github:
        # The GitHub organization or user.
        owner: mcfuhrt
        # The Github repository
        repo: argo-dbt
        # Labels is used to filter the PRs that you want to target. (optional)
        # labels:
        # - preview
        tokenRef:
          secretName: github-token
          key: token
      requeueAfterSeconds: 30
      values:
        cluster: dbp05
        environment: prd
  template:
    metadata:
      name: "recce-{{ .branch }}-{{ .number }}"
      labels:
        cluster: '{{ .values.cluster }}'
        environment: '{{ .values.environment }}'
        application: recce
        branch: "{{ .branch }}"
        pr_number: "{{ .number }}"
    spec:
      project: recce
      destination:
        name: in-cluster
        namespace: recce
      sources:
        - repoURL: git@github.com:mcfuhrt/argo-applications.git
          targetRevision: main
          path: recce
          helm:
            releaseName: "recce-pr-{{ .number }}"
            valueFiles:
              - values.yaml
              - overrides/common.yaml
            values: |
              # PR-specific overrides for unique resource naming
              nameOverride: "recce-pr-{{ .number }}"
              
              # PR path within GCS bucket
              prPath: "pr-{{ .number }}"
              
              # GCS bucket mount configuration
              dataMount:
                # type: pvc
                pvcName: "recce-pr-{{ .number }}-pvc"
                pvName: "recce-pr-{{ .number }}-pv"
                # mountPath: /data
              
              # PR-specific environment variables
              env:
                PR_NUMBER: "{{ .number }}"
                PR_DATA_PATH: "pr-{{ .number }}"
              
              # Enhanced ingress with automatic DNS and SSL using nginx
              ingress:
                annotations:
                  external-dns.alpha.kubernetes.io/hostname: "recce-pr-{{ .number }}.sikwel.de"
                hosts:
                  - host: "recce-pr-{{ .number }}.sikwel.de"
                    paths:
                      - path: /
                        pathType: Prefix
                tls:
                  - secretName: "recce-pr-{{ .number }}-tls"
                    hosts:
                      - "recce-pr-{{ .number }}.sikwel.de"
      info:
      - name: Description
        value: >-
          This service starts a recce server synced from a cloud source.

      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true