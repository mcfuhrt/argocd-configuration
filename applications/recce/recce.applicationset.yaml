apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: recce
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
  - pullRequest:
      # github:
      #   # The GitHub organization or user.
      #   owner: mcfuhrt
      #   # The Github repository
      #   repo: argo-dbt
      #   # Labels is used to filter the PRs that you want to target. (optional)
      #   # labels:
      #   # - preview
      #   tokenRef:
      #     secretName: github-token
      #     key: token
      azuredevops:
        # Azure DevOps org to scan. Required.
        organization: hinnenkamp
        # Azure DevOps project name to scan. Required.
        project: recce
        # Azure DevOps repo name to scan. Required.
        repo: dbt
        # The Azure DevOps API URL to talk to. If blank, use https://dev.azure.com/.
        api: https://dev.azure.com/
        # Reference to a Secret containing an access token. (optional)
        tokenRef:
          secretName: devops-token
          key: token
        # Labels is used to filter the PRs that you want to target. (optional)
        labels:
        - preview
      requeueAfterSeconds: 30
      values:
        cluster: in-cluster
        environment: prd
        release: recce-pr-{{ .number }}
  template:
    metadata:
      name: recce-{{ .branch }}-{{ .number }}
      labels:
        cluster: '{{ .values.cluster }}'
        environment: '{{ .values.environment }}'
        application: recce
        branch: "{{ .branch }}"
        pr_number: "{{ .number }}"
    spec:
      project: recce
      destination:
        namespace: recce
        name: '{{ .values.cluster }}'
      sources:
          # GitHub
        # - repoURL: git@github.com:mcfuhrt/argo-applications.git
        #   targetRevision: main
        #   path: recce
          # Azure DevOps
        - repoURL: git@ssh.dev.azure.com:v3/hinnenkamp/recce/applications
          targetRevision: development
          path: .
          helm:
            releaseName: '{{ .values.release }}'
            valueFiles:
              - values.yaml
              - overrides/common.yaml
            values: |
              # PR-specific overrides for unique resource naming
              nameOverride: '{{ .values.release }}'
              
              # PR path within GCS bucket
              prPath: 'pr-{{ .number }}'
              
              # GCS bucket mount configuration
              dataMount:
                pvcName: {{ .values.release }}-pvc
                pvName: {{ .values.release }}-pv
              
              # PR-specific environment variables
              env:
                PR_NUMBER: '{{ .number }}'
                PR_DATA_PATH: 'pr-{{ .number }}'
              
              # Enhanced ingress with automatic DNS and SSL using nginx
              ingress:
                annotations:
                  external-dns.alpha.kubernetes.io/hostname: "{{ .values.release }}.sikwel.de"
                hosts:
                  - host: {{ .values.release }}.sikwel.de
                    paths:
                      - path: /
                        pathType: Prefix
                tls:
                  - secretName: {{ .values.release }}-tls
                    hosts:
                      - {{ .values.release }}.sikwel.de
      info:
      - name: Description
        value: >-
          This service starts a recce server synced from a cloud source.

      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true