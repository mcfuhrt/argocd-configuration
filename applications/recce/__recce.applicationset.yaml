apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: recce
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
  - pullRequest:
      github:
        # The GitHub organization or user.
        owner: mcfuhrt
        # The Github repository
        repo: argo-dbt
        # Labels is used to filter the PRs that you want to target. (optional)
        # labels:
        # - preview
        tokenRef:
          secretName: github-token
          key: token
      requeueAfterSeconds: 30
  template:
    metadata:
      name: "recce-{{ .branch }}-{{ .number }}"
      labels:
        application: recce
        branch: "{{ .branch }}"
        pr_number: "{{ .number }}"
    spec:
      project: recce
      destination:
        name: in-cluster
        namespace: recce
      source:
        repoURL: git@github.com:mcfuhrt/argo-applications.git
        targetRevision: main
        path: recce
        helm:
          releaseName: "recce-pr-{{ .number }}"
          valueFiles:
            - overrides/stg.yaml
          values: |
            # PR-specific overrides for unique resource naming
            nameOverride: "recce-pr-{{ .number }}"
            
            # Shared service account (as required)  
            serviceAccount:
              create: false
              name: datahub-dbt
            serviceAccountName: datahub-dbt
            
            # GCS configuration  
            storage:
              bucketName: "sikwel-playground-recce-data"
            
            # PR path within GCS bucket
            prPath: "pr-{{ .number }}"
            
            # GCS bucket mount configuration (entire bucket)
            dataMount:
              type: pvc
              pvcName: "recce-pr-{{ .number }}-pvc"
              pvName: "recce-pr-{{ .number }}-pv"
              mountPath: /data
            
            # PR-specific environment variables
            env:
              PR_NUMBER: "{{ .number }}"
              PR_DATA_PATH: "pr-{{ .number }}"
            
            # Enhanced ingress with automatic DNS and SSL using nginx
            ingress:
              enabled: true
              className: "nginx"
              hostname: "recce-pr-{{ .number }}.sikwel.de"
              hosts:
                - host: "recce-pr-{{ .number }}.sikwel.de"
                  paths:
                    - path: /
                      pathType: Prefix
              annotations:
                external-dns.alpha.kubernetes.io/hostname: "recce-pr-{{ .number }}.sikwel.de"
                external-dns.alpha.kubernetes.io/ttl: "300"
                cert-manager.io/cluster-issuer: "letsencrypt-prod"
              tls:
                enabled: true
                secretName: "recce-pr-{{ .number }}-tls"
                hostname: "recce-pr-{{ .number }}.sikwel.de"
      syncPolicy:
        automated:
          prune: true
          selfHeal: false
        syncOptions:
          - CreateNamespace=true