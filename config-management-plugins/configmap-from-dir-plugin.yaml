# argocd/config-management-plugins/configmap-from-dir-plugin.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: configmap-from-dir-plugin
  namespace: argocd
data:
  configmap-from-dir.yaml: |  # ← Plugin Config
    version: v1.0.0
    name: ConfigMapFromDirectory
    init:
      command: [sh]
      args: ["-c", "echo 'Initializing directory scan...'"]
    generate:
      command: [sh]
      args:
      - -c
      - |
        # ArgoCD stellt diese Vars bereit
        APP_PATH="$ARGOCD_APP_SOURCE_PATH"
        APP_NAME="$ARGOCD_APP_NAME"
        TARGET_NAMESPACE="$ARGOCD_APP_TARGET_NAMESPACE"
        
        echo "Generating ConfigMap for $APP_NAME from $APP_PATH"
        
        # ConfigMap mit ALLEN Dateien im Ordner erstellen
        kubectl create configmap "${APP_NAME}-config" \
          --namespace="$TARGET_NAMESPACE" \
          --from-file="$APP_PATH/" \
          --dry-run=client -o yaml > /tmp/configmap.yaml
        
        # Deployer Deployment generieren
        cat > /tmp/deployer.yaml << EOF
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: prefect-deployer-${APP_NAME}
          namespace: ${TARGET_NAMESPACE}
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: prefect-deployer-${APP_NAME}
          template:
            metadata:
              labels:
                app: prefect-deployer-${APP_NAME}
              annotations:
                checksum/config: "true"
            spec:
              serviceAccountName: prefect-deployer-sa-${APP_NAME}
              initContainers:
              - name: deploy-connector
                image: prefecthq/prefect:3-latest-python3.11
                command: ["/bin/bash"]
                args:
                - -c
                - |
                  export PYTHONPATH=/configs
                  cd /configs/${APP_NAME}-config
                  ls -la
                  python blocks.py || true
                  prefect config set PREFECT_API_URL "http://prefect-server-api.\${TARGET_NAMESPACE}.svc/api"
                  prefect deployment apply prefect.yaml || true
                  echo "✓ ${APP_NAME} deployed"
                volumeMounts:
                - name: connector-config
                  mountPath: /configs
                env:
                - name: PREFECT_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: prefect-api-key
                      key: token
              containers:
              - name: placeholder
                image: busybox
                command: ["sleep", "365d"]
              volumes:
              - name: connector-config
                configMap:
                  name: "${APP_NAME}-config"
        EOF
        
        # Ausgabe aller generierten Manifests
        cat /tmp/configmap.yaml /tmp/deployer.yaml
